<!DOCTYPE html>
<html>
<head>
    <title>Cube World Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <style>
        :root { --primary: #e67e22; --bg: #567d46; }
        body { margin: 0; background: #222; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; touch-action: none; position: fixed; width: 100%; height: 100%; }
        
        /* Fullscreen Canvas */
        canvas { display: none; background: var(--bg); touch-action: none; }

        /* Login Screen */
        #login-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #2c3e50, #000); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .login-box { background: white; padding: 40px; border-radius: 25px; display: flex; flex-direction: column; gap: 20px; width: 300px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-top: 5px solid var(--primary); }
        .login-box h1 { margin: 0; color: #333; font-size: 24px; letter-spacing: 2px; }
        .login-box input { padding: 15px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; outline: none; transition: 0.3s; }
        .login-box input:focus { border-color: var(--primary); }
        .login-box button { padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 18px; cursor: pointer; box-shadow: 0 4px 0 #d35400; }
        .login-box button:active { transform: translateY(2px); box-shadow: none; }

        /* HUD */
        .ui-panel { position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.9); padding: 10px 20px; border-radius: 30px; z-index: 10; display: none; gap: 15px; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #leaderboard { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 15px; font-size: 13px; min-width: 120px; display: none; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
        #leaderboard b { color: var(--primary); display: block; margin-bottom: 5px; text-transform: uppercase; font-size: 10px; }
        
        /* Mobile Controls */
        #mobile-controls { position: absolute; bottom: 40px; width: 100%; display: none; justify-content: space-between; padding: 0 30px; box-sizing: border-box; pointer-events: none; z-index: 20; }
        .joy-base { width: 100px; height: 100px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; position: relative; pointer-events: auto; backdrop-filter: blur(2px); }
        #stick { width: 40px; height: 40px; background: white; border-radius: 50%; position: absolute; left: 30px; top: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .m-btn { width: 70px; height: 70px; background: rgba(0,0,0,0.5); border: 2px solid white; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; pointer-events: auto; text-transform: uppercase; font-size: 12px; }
        
        #chat-container { position: absolute; bottom: 130px; left: 20px; width: 220px; pointer-events: none; }
        #chat-messages { height: 120px; overflow: hidden; display: flex; flex-direction: column-reverse; gap: 5px; }
        #chat-input { width: 100%; background: white; border: none; padding: 12px; visibility: hidden; pointer-events: auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h1>CUBE WORLD</h1>
            <input type="text" id="username" placeholder="Character Name" maxlength="10">
            <button id="start-btn">ENTER WORLD</button>
            <p style="font-size: 10px; color: #999;">Tip: Click/Tap to go Fullscreen</p>
        </div>
    </div>

    <div id="leaderboard"><b>Leaderboard</b><div id="scores"></div></div>

    <div class="ui-panel" id="ui">
        <input type="color" id="colorPicker" value="#3498db">
        <span id="display-name" style="font-weight:bold; color: #333;"></span>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="chat-container"><div id="chat-messages"></div><input type="text" id="chat-input" placeholder="Say something..." maxlength="35"></div>

    <div id="mobile-controls">
        <div class="joy-base" id="joyBase"><div id="stick"></div></div>
        <div style="display:flex; flex-direction:column; gap:15px;">
            <div id="chat-btn" class="m-btn">Chat</div>
            <div id="jump-btn" class="m-btn" style="background: var(--primary); border:none;">Jump</div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const SERVER_URL = "https://two-5d-game.onrender.com"; 
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let socket, myId = "local";
        let players = {}, coin = {x:0, y:0}, trails = [];
        const me = { x: 400, y: 400, z: 0, jv: 0, ground: true, ix: 0, iy: 0, nick: "", score: 0 };
        const keys = {};

        // DECORATIONS (Static)
        const decos = [];
        for(let i=0; i<15; i++) {
            decos.push({ x: Math.random()*2000, y: Math.random()*2000, type: Math.random() > 0.5 ? 'tree' : 'flower' });
        }

        const obstacles = [{x: 400, y: 300, w: 120, h: 50}];
        const lavaZones = [{x: 800, y: 200, w: 150, h: 100}];

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.onresize = resize; resize();

        // FULLSCREEN TRIGGER
        function requestFullscreen() {
            const doc = window.document.documentElement;
            if (doc.requestFullscreen) doc.requestFullscreen();
            else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
        }

        document.getElementById('start-btn').onclick = () => {
            me.nick = document.getElementById('username').value.trim() || "Cube";
            document.getElementById('login-overlay').style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('ui').style.display = 'flex';
            document.getElementById('leaderboard').style.display = 'block';
            document.getElementById('mobile-controls').style.display = 'flex';
            document.getElementById('display-name').innerText = me.nick;
            
            requestFullscreen();
            connectToServer();
            requestAnimationFrame(draw);
        };

        function connectToServer() {
            socket = io(SERVER_URL);
            socket.on('init', (data) => { myId = data.id; coin = data.coin; });
            socket.on('updatePlayers', (data) => { 
                players = data; 
                const list = Object.values(players).sort((a,b) => b.score - a.score).slice(0,5);
                document.getElementById('scores').innerHTML = list.map(p => `<div>${p.nick}: <b>${p.score}</b></div>`).join('');
            });
            socket.on('coinUpdate', (c) => { coin = c; });
            socket.on('newChatMessage', (data) => {
                const m = document.createElement('div'); m.className = 'message';
                m.innerHTML = `<b>${data.id}:</b> ${data.text}`;
                document.getElementById('chat-messages').prepend(m);
                setTimeout(() => m.remove(), 5000);
            });
        }

        // CONTROLS
        window.onkeydown = (e) => { 
            if(e.key === ' ' && me.ground) { me.jv = 11; me.ground = false; }
            keys[e.key.toLowerCase()] = true; 
        };
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        document.getElementById('jump-btn').ontouchstart = (e) => { 
            e.preventDefault(); 
            if(me.ground) { me.jv = 11; me.ground = false; }
        };

        const chatInput = document.getElementById('chat-input');
        function toggleChat() {
            if (chatInput.style.visibility === 'visible') {
                if (chatInput.value.trim() && socket) socket.emit('chatMessage', chatInput.value.trim());
                chatInput.value = ''; chatInput.style.visibility = 'hidden'; chatInput.blur();
            } else { chatInput.style.visibility = 'visible'; chatInput.focus(); }
        }
        document.getElementById('chat-btn').ontouchstart = (e) => { e.preventDefault(); toggleChat(); };

        // JOYSTICK
        const jBase = document.getElementById('joyBase'), stick = document.getElementById('stick');
        jBase.ontouchstart = jBase.ontouchmove = (e) => {
            e.preventDefault();
            const r = jBase.getBoundingClientRect();
            const touch = e.touches[0];
            const dx = touch.clientX - (r.left + 50), dy = touch.clientY - (r.top + 50);
            const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 40), ang = Math.atan2(dy, dx);
            me.ix = (Math.cos(ang) * dist) / 40; me.iy = (Math.sin(ang) * dist) / 40;
            stick.style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
        };
        jBase.ontouchend = () => { me.ix = me.iy = 0; stick.style.transform = `translate(0,0)`; };

        function update() {
            let speed = 4.5;
            let mx = me.ix, my = me.iy;
            if(keys['w']) my = -1; if(keys['s']) my = 1; if(keys['a']) mx = -1; if(keys['d']) mx = 1;

            let nx = me.x + mx * speed, ny = me.y + my * (speed*0.7);

            // Obstacle logic
            let hit = false;
            obstacles.forEach(o => {
                if(nx > o.x && nx < o.x+o.w && ny > o.y && ny < o.y+o.h && me.z < 20) hit = true;
            });
            if(!hit) { me.x = nx; me.y = ny; }

            // Lava logic
            lavaZones.forEach(l => {
                if(me.x > l.x && me.x < l.x+l.w && me.y > l.y && me.y < l.y+l.h && me.ground) {
                    me.x = 100; me.y = 100;
                }
            });

            if(!me.ground) {
                me.z += me.jv; me.jv -= 0.6;
                if(me.z <= 0) { me.z = 0; me.jv = 0; me.ground = true; }
            }

            // Sync
            if(socket) socket.emit('move', { x: me.x, y: me.y, z: me.z, color: document.getElementById('colorPicker').value, nick: me.nick });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw Lava
            ctx.fillStyle = "rgba(231, 76, 60, 0.6)";
            lavaZones.forEach(l => ctx.fillRect(l.x, l.y, l.w, l.h));

            // Draw Obstacles (Walls)
            ctx.fillStyle = "#34495e";
            obstacles.forEach(o => {
                ctx.fillRect(o.x, o.y, o.w, o.h);
                ctx.fillStyle = "#2c3e50";
                ctx.fillRect(o.x, o.y, o.w, 10); // Wall top
            });

            // Draw Decor (Walk behind/in front logic)
            decos.forEach(d => {
                if(d.type === 'tree') {
                    ctx.fillStyle = "#3e2723"; ctx.fillRect(d.x-4, d.y-20, 8, 20); // Trunk
                    ctx.fillStyle = "#2e7d32"; ctx.beginPath(); ctx.arc(d.x, d.y-25, 15, 0, 7); ctx.fill(); // Leaves
                } else {
                    ctx.fillStyle = "#f1c40f"; ctx.beginPath(); ctx.arc(d.x, d.y, 3, 0, 7); ctx.fill(); // Flower
                }
            });

            // Draw Coin
            ctx.fillStyle = "#f1c40f"; ctx.beginPath(); ctx.arc(coin.x, coin.y, 10, 0, 7); ctx.fill();
            ctx.shadowBlur = 15; ctx.shadowColor = "gold"; ctx.strokeStyle = "white"; ctx.stroke();
            ctx.shadowBlur = 0;

            // Players
            Object.values(players).forEach(p => {
                drawCube(p.x, p.y, p.z, p.color, p.nick, p.id === myId, p.lastMsg);
            });

            // Draw local cube if not in players list yet
            if(!players[myId]) drawCube(me.x, me.y, me.z, colorPicker.value, me.nick, true);

            update();
            requestAnimationFrame(draw);
        }

        function drawCube(x, y, z, color, nick, isMe, msg) {
            const dy = y - (z || 0) - 30;
            ctx.fillStyle = "rgba(0,0,0,0.2)";
            ctx.beginPath(); ctx.ellipse(x, y, 15, 8, 0, 0, 7); ctx.fill();
            ctx.fillStyle = color;
            ctx.fillRect(x-12, dy, 24, 30);
            if(isMe) { ctx.strokeStyle = "white"; ctx.lineWidth = 3; ctx.strokeRect(x-12, dy, 24, 30); }
            
            ctx.fillStyle = "white"; ctx.font = "bold 12px sans-serif"; ctx.textAlign = "center";
            ctx.fillText(nick, x, dy-12);

            if(msg) {
                ctx.fillStyle = "white"; ctx.beginPath(); ctx.roundRect(x-40, dy-45, 80, 22, 5); ctx.fill();
                ctx.fillStyle = "#333"; ctx.font = "10px sans-serif"; ctx.fillText(msg.substring(0,15), x, dy-30);
            }
        }
    </script>
</body>
</html>
