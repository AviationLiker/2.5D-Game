<!DOCTYPE html>
<html>
<head>
    <title>Cube World: Battle Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <style>
        /* ... (Existing CSS remains the same) ... */
        body { margin: 0; background: #222; font-family: 'Segoe UI', sans-serif; overflow: hidden; touch-action: none; position: fixed; width: 100%; height: 100%; }
        canvas { display: none; border: 6px solid #333; margin: 0 auto; background: #567d46; cursor: crosshair; }
        #login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .login-box { background: white; padding: 30px; border-radius: 20px; display: flex; flex-direction: column; gap: 15px; width: 280px; text-align: center; }
        .login-box button { padding: 12px; background: #e67e22; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .ui-panel { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.9); padding: 8px 15px; border-radius: 25px; z-index: 10; display: none; gap: 10px; align-items: center; }
        #leaderboard { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 12px; border-radius: 12px; font-size: 12px; min-width: 110px; display: none; }
        #chat-container { position: absolute; bottom: 120px; left: 20px; width: 240px; pointer-events: none; z-index: 50; }
        #chat-messages { height: 100px; overflow: hidden; display: flex; flex-direction: column-reverse; gap: 5px; }
        .message { background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 6px; font-size: 12px; }
        #chat-input { width: 100%; background: white; border: 3px solid #3498db; padding: 12px; visibility: hidden; pointer-events: auto; border-radius: 10px; outline: none; }
        #mobile-controls { position: absolute; bottom: 30px; width: 100%; display: none; justify-content: space-between; padding: 0 30px; box-sizing: border-box; pointer-events: none; }
        .joy-base { width: 90px; height: 90px; background: rgba(255,255,255,0.2); border: 3px solid white; border-radius: 50%; position: relative; pointer-events: auto; }
        #stick { width: 35px; height: 35px; background: white; border-radius: 50%; position: absolute; left: 27.5px; top: 27.5px; }
        .m-btn { width: 60px; height: 60px; background: rgba(0,0,0,0.4); border: 2px solid white; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; pointer-events: auto; user-select: none; font-size: 10px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h1>CUBE WORLD</h1>
            <input type="text" id="username" placeholder="Nickname" maxlength="10">
            <button id="start-btn">PLAY NOW</button>
            <p style="font-size:10px; color:#666">WASD to Move | Shift to Dash | E to Attack</p>
        </div>
    </div>

    <div id="leaderboard"><b>Top Players</b><hr><div id="scores"></div></div>
    <div class="ui-panel" id="ui"><input type="color" id="colorPicker" value="#3498db"><span id="display-name"></span></div>
    <canvas id="gameCanvas"></canvas>
    <div id="chat-container"><div id="chat-messages"></div><input type="text" id="chat-input" placeholder="Type..." maxlength="35"></div>

    <div id="mobile-controls">
        <div class="joy-base" id="joyBase"><div id="stick"></div></div>
        <div style="display:flex; gap:10px; align-items: flex-end;">
            <div id="chat-btn" class="m-btn">CHAT</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <div id="attack-btn" class="m-btn" style="background:#c0392b; border:none;">ATTACK</div>
                <div id="dash-btn" class="m-btn" style="background:#3498db; border:none;">DASH</div>
                <div id="jump-btn" class="m-btn" style="background:#e67e22; border:none;">JUMP</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const SERVER_URL = "https://two-5d-game.onrender.com"; 
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const chatInput = document.getElementById('chat-input');
        
        let socket, myId = null;
        let players = {}, enemies = [], coin = {x:0, y:0}, trails = [];
        const me = { x: 300, y: 300, z: 0, jv: 0, ground: true, ix: 0, iy: 0, nick: "", score: 0, dashTimer: 0, attackVisual: 0 };
        const keys = {};
        let isSpecialDay = false;

        // Birthday Logic
        const now = new Date();
        isSpecialDay = (now.getDate() === 21 && now.getMonth() === 1) || (now.getDate() === 20 && now.getMonth() === 7) || (now.getDate() === 23 && now.getMonth() === 8);

        // Sound Engine
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            if(type==='jump'){ osc.frequency.setValueAtTime(150,0); osc.frequency.linearRampToValueAtTime(400,0.1); gain.gain.fadeOut=0.2; }
            if(type==='attack'){ osc.type='sawtooth'; osc.frequency.setValueAtTime(200,0); osc.frequency.linearRampToValueAtTime(50,0.1); }
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        document.getElementById('start-btn').onclick = () => {
            me.nick = document.getElementById('username').value.trim() || "Cube";
            document.getElementById('login-overlay').style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('ui').style.display = 'flex';
            document.getElementById('leaderboard').style.display = 'block';
            document.getElementById('mobile-controls').style.display = 'flex';
            document.getElementById('display-name').innerText = me.nick;
            connectToServer();
            requestAnimationFrame(draw);
        };

        function connectToServer() {
            socket = io(SERVER_URL);
            socket.on('init', (data) => { myId = data.id; coin = data.coin; });
            socket.on('updatePlayers', (data) => { players = data; });
            socket.on('enemyUpdate', (data) => { enemies = data; });
            socket.on('coinUpdate', (c) => { coin = c; });
        }

        // ATTACK LOGIC
        function performAttack() {
            me.attackVisual = 10; // Frames to show the blast ring
            playSound('attack');
            enemies.forEach(en => {
                let dx = en.x - me.x, dy = en.y - me.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < 80) { // Attack Range
                    socket.emit('destroyEnemy', en.id);
                }
            });
        }

        window.onkeydown = (e) => { 
            if(e.key === ' ' && me.ground && document.activeElement !== chatInput) { me.jv = 11; me.ground = false; playSound('jump'); }
            if(e.key === 'Shift') me.dashTimer = 20;
            if(e.key.toLowerCase() === 'e') performAttack();
            if(e.key === 'Enter') toggleChat();
            if(e.key === '/') { if(document.activeElement !== chatInput) { e.preventDefault(); toggleChat(true); } }
            keys[e.key.toLowerCase()] = true; 
        };
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        document.getElementById('attack-btn').ontouchstart = (e) => { e.preventDefault(); performAttack(); };
        document.getElementById('jump-btn').ontouchstart = (e) => { e.preventDefault(); if(me.ground){me.jv=11; me.ground=false; playSound('jump');}};
        document.getElementById('dash-btn').ontouchstart = (e) => { e.preventDefault(); me.dashTimer = 20; };
        
        // Joystick (simplified)
        const jBase = document.getElementById('joyBase'), stick = document.getElementById('stick');
        jBase.ontouchmove = (e) => {
            const r = jBase.getBoundingClientRect();
            const dx = e.touches[0].clientX - (r.left + 45), dy = e.touches[0].clientY - (r.top + 45);
            const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 35), ang = Math.atan2(dy, dx);
            me.ix = Math.cos(ang) * (dist/35); me.iy = Math.sin(ang) * (dist/35);
            stick.style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
        };
        jBase.ontouchend = () => { me.ix = me.iy = 0; stick.style.transform = `translate(0,0)`; };

        function update() {
            let speed = (me.dashTimer > 0) ? 10 : 4.5;
            if(me.dashTimer > 0) me.dashTimer--;
            if(me.attackVisual > 0) me.attackVisual--;

            if(document.activeElement !== chatInput){
                if(keys['w']) me.iy = -1; else if(keys['s']) me.iy = 1; else if(!me.ix) me.iy = 0;
                if(keys['a']) me.ix = -1; else if(keys['d']) me.ix = 1; else if(!me.iy) me.ix = 0;
            }

            me.x += me.ix * speed; me.y += me.iy * (speed*0.75);
            if(!me.ground) { me.z += me.jv; me.jv -= 0.6; if(me.z <= 0) { me.z = 0; me.ground = true; }}

            // Enemy Logic (Local visual prediction)
            enemies.forEach(en => {
                let dx = me.x - en.x, dy = me.y - en.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < 20 && me.z < 10) { me.x = 300; me.y = 300; } // Death reset
                en.x += (dx/dist) * en.speed; en.y += (dy/dist) * en.speed;
            });

            if(socket?.connected) socket.emit('move', { x: me.x, y: me.y, z: me.z, color: colorPicker.value, nick: me.nick });
        }

        function draw() {
            ctx.fillStyle = "#567d46"; ctx.fillRect(0,0,canvas.width, canvas.height);
            
            // Draw Coin
            ctx.fillStyle = "#f1c40f"; ctx.beginPath(); ctx.arc(coin.x, coin.y, 10, 0, 7); ctx.fill();

            // Draw Enemies
            enemies.forEach(en => {
                ctx.fillStyle = "#c0392b";
                ctx.beginPath(); ctx.moveTo(en.x, en.y-15); ctx.lineTo(en.x+10, en.y+5); ctx.lineTo(en.x-10, en.y+5); ctx.fill();
            });

            // Draw Attack Visual
            if(me.attackVisual > 0) {
                ctx.strokeStyle = `rgba(255,255,255,${me.attackVisual/10})`;
                ctx.lineWidth = 5;
                ctx.beginPath(); ctx.arc(me.x, me.y, 80 - me.attackVisual*4, 0, 7); ctx.stroke();
            }

            // Draw Players
            Object.keys(players).forEach(id => {
                const p = players[id];
                drawCube(p.x, p.y, p.z, p.color, p.nick, id === myId, p.lastMsg);
            });

            update();
            requestAnimationFrame(draw);
        }

        function drawCube(x, y, z, color, nick, isMe, msg) {
            const dy = y - (z || 0) - 30;
            if(isSpecialDay){
                ctx.fillStyle = "#e67e22"; ctx.beginPath(); ctx.moveTo(x-12, dy); ctx.lineTo(x, dy-20); ctx.lineTo(x+12, dy); ctx.fill();
            }
            ctx.fillStyle = color; ctx.fillRect(x-12, dy, 24, 30);
            ctx.fillStyle = "white"; ctx.font = "bold 12px sans-serif"; ctx.textAlign = "center";
            ctx.fillText(nick, x, dy-12);
            if(msg){ ctx.fillStyle="white"; ctx.fillRect(x-40, dy-45, 80, 20); ctx.fillStyle="black"; ctx.fillText(msg, x, dy-32); }
        }

        function toggleChat(forceOpen = false) {
            if(forceOpen || chatInput.style.visibility !== 'visible'){
                chatInput.style.visibility = 'visible'; chatInput.focus();
            } else {
                if(chatInput.value.trim()) socket.emit('chatMessage', chatInput.value.trim());
                chatInput.value = ''; chatInput.style.visibility = 'hidden'; chatInput.blur();
            }
        }
    </script>
</body>
</html>
